name: Discord Component Notification

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]
    types: [opened, closed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  # --- ç”»åƒã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆ ---
  create: # Branch or tag creation
  discussion_comment:
    types: [created] # Discussion comments
  pull_request_review_comment:
    types: [created] # Pull request review comments

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    # PRã«é–¢é€£ã—ãªã„Issueã‚³ãƒ¡ãƒ³ãƒˆã¯é™¤å¤–
    if: github.event.issue.pull_request || github.event_name != 'issue_comment'
    steps:
      - name: Prepare Notification Details
        id: info
        run: |
          case "${{ github.event_name }}" in
            "push")
              TITLE="ğŸ“¦ ãƒ–ãƒ©ãƒ³ãƒ${{ github.ref_name }}ã«pushã•ã‚Œã¾ã—ãŸ"
              DESC="ã‚³ãƒŸãƒƒãƒˆå†…å®¹: ${{ github.event.head_commit.message }}"
              URL="${{ github.event.compare }}"
              COLOR=3066993 # Blue
              BRANCH="${{ github.ref_name }}"
              ;;
            "pull_request")
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE=":white_check_mark: PRãŒMergeã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=6570404 # Purple
              elif [ "${{ github.event.action }}" = "closed" ]; then
                TITLE=":x: PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=15158332 # Red
              else
                TITLE=":new: PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=3066993 # Blue
              fi
              DESC="${{ github.event.pull_request.title }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              URL="${{ github.event.pull_request.html_url }}"
              ;;
            "pull_request_review")
              TITLE="ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ github.event.review.state }}"
              DESC="Pull Request: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.review.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570 # Orange
              ;;
            "issue_comment")
              TITLE="ğŸ’¬ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="${{ github.ref_name }}"
              COLOR=12370112 # Grey
              ;;
            # --- æ–°è¦è¿½åŠ åˆ† ---
            "create")
              TITLE="ğŸŒ¿ ${{ github.event.ref_type }}ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ${{ github.event.ref }}"
              DESC="ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
              URL="https://github.com/${{ github.repository }}/tree/${{ github.event.ref }}"
              BRANCH="${{ github.event.ref }}"
              COLOR=3066993 # Blue
              ;;
            "discussion_comment")
              TITLE="ğŸ’¬ ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="Discussions"
              COLOR=12370112 # Grey
              ;;
            "pull_request_review_comment")
              TITLE="ğŸ“ PRã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570 # Orange
              ;;
            "pull_request_review_thread")
              TITLE="ğŸ§µ PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ${{ github.event.action }}ã•ã‚Œã¾ã—ãŸ"
              DESC="PR: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.pull_request.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570 # Orange
              ;;
          esac

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Send Discord Webhook Embed
        shell: bash
        env:
          TITLE: ${{ steps.info.outputs.title }}
          DESC: ${{ steps.info.outputs.desc }}
          URL: ${{ steps.info.outputs.url }}
          COLOR: ${{ steps.info.outputs.color }}
          BRANCH: ${{ steps.info.outputs.branch }}
          SENDER: ${{ github.actor }}
        run: |
          TITLE_VAL="${TITLE:-No Title}"
          DESC_VAL="${DESC:-No Description}"
          COLOR_VAL="${COLOR:-3066993}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "'"${TITLE_VAL//\"/\\\"}"'",
                   "description": "'"${DESC_VAL//\"/\\\"}"'",
                   "color": '"${COLOR_VAL}"',
                   "url": "'"${URL}"'",
                   "author": {
                     "name": "'"${SENDER}"'",
                     "icon_url": "https://github.com/'"${SENDER}"'.png",
                     "url": "https://github.com/'"${SENDER}"'"
                   },
                   "fields": [
                     { "name": "ğŸ‘¤ æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼", "value": "'"${SENDER}"'", "inline": true },
                     { "name": ":deciduous_tree: ãƒ–ãƒ©ãƒ³ãƒ", "value": "'"${BRANCH}"'", "inline": true }
                   ]
                 }],
                 "components": [
                   {
                     "type": 1,
                     "components": [
                       {
                         "type": 2,
                         "style": 5,
                         "label": "GitHubã§ç¢ºèªã™ã‚‹",
                         "url": "'"${URL}"'"
                       }
                     ]
                   }
                 ]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
