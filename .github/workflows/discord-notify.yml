name: Discord Component Notification

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]
    types: [opened, closed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  create: # Branch or tag creation
  discussion_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request || github.event_name != 'issue_comment'
    steps:
      - name: Prepare Notification Details
        id: info
        run: |
          # --- IDãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•° ---
          get_mention() {
            case "$1" in
              "tukuyomil032") echo "<@745902312345567252>" ;;
              "zibasan")      echo "<@1100794879019323393>" ;;
              *)              echo "@here" ;;
            esac
          }

          # åŸºæœ¬ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆæ“ä½œã—ãŸäººï¼‰
          MENTION=$(get_mention "${{ github.actor }}")

          case "${{ github.event_name }}" in
            "push")
              TITLE="ğŸ“¦ ãƒ–ãƒ©ãƒ³ãƒ${{ github.ref_name }}ã«pushã•ã‚Œã¾ã—ãŸ"
              DESC="ã‚³ãƒŸãƒƒãƒˆå†…å®¹: ${{ github.event.head_commit.message }}"
              URL="${{ github.event.compare }}"
              COLOR=3066993
              BRANCH="${{ github.ref_name }}"
              ;;
            "pull_request")
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE=":white_check_mark: PRãŒMergeã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=6570404
                # ãƒãƒ¼ã‚¸æ™‚ã¯ã€Œãƒãƒ¼ã‚¸ã—ãŸäººã€ã¨ã€ŒPRä½œæˆè€…ã€ã®ä¸¡æ–¹ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
                AUTHOR_MENTION=$(get_mention "${{ github.event.pull_request.user.login }}")
                MENTION="$MENTION $AUTHOR_MENTION"
              elif [ "${{ github.event.action }}" = "closed" ]; then
                TITLE=":x: PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=15158332
              else
                TITLE=":new: PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=3066993
              fi
              DESC="${{ github.event.pull_request.title }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              URL="${{ github.event.pull_request.html_url }}"
              ;;
            "pull_request_review")
              TITLE="ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ github.event.review.state }}"
              DESC="Pull Request: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.review.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570
              ;;
            "issue_comment")
              TITLE="ğŸ’¬ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="Pull Request #${{ github.event.issue.number }}"
              COLOR=12370112
              ;;
            "create")
              TITLE="ğŸŒ¿ ${{ github.event.ref_type }}ä½œæˆ: ${{ github.event.ref }}"
              DESC="ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
              URL="https://github.com/${{ github.repository }}/tree/${{ github.event.ref }}"
              BRANCH="${{ github.event.ref }}"
              COLOR=3066993
              ;;
            "discussion_comment")
              TITLE="ğŸ’¬ Discussionã‚³ãƒ¡ãƒ³ãƒˆ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="Discussions"
              COLOR=12370112
              ;;
            "pull_request_review_comment")
              TITLE="ğŸ“ PRã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570
              ;;
            "pull_request_review_thread")
              TITLE="ğŸ§µ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ${{ github.event.action }}ã•ã‚Œã¾ã—ãŸ"
              DESC="PR: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.pull_request.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570
              ;;
          esac

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "mention=$MENTION" >> $GITHUB_OUTPUT

      - name: Send Discord Webhook Embed
        shell: bash
        env:
          TITLE: ${{ steps.info.outputs.title }}
          DESC: ${{ steps.info.outputs.desc }}
          URL: ${{ steps.info.outputs.url }}
          COLOR: ${{ steps.info.outputs.color }}
          BRANCH: ${{ steps.info.outputs.branch }}
          MENTION: ${{ steps.info.outputs.mention }}
          SENDER: ${{ github.actor }}
        run: |
          TITLE_VAL="${TITLE:-No Title}"
          DESC_VAL="${DESC:-No Description}"
          COLOR_VAL="${COLOR:-3066993}"

          # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«é£›ã°ã™ãŸã‚ã€contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«MENTIONã‚’å…¥ã‚Œã¾ã™
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "content": "'"${MENTION}"'",
                 "embeds": [{
                   "title": "'"${TITLE_VAL//\"/\\\"}"'",
                   "description": "'"${DESC_VAL//\"/\\\"}"'",
                   "color": '"${COLOR_VAL}"',
                   "url": "'"${URL}"'",
                   "author": {
                     "name": "'"${SENDER}"'",
                     "icon_url": "https://github.com/'"${SENDER}"'.png",
                     "url": "https://github.com/'"${SENDER}"'"
                   },
                   "fields": [
                     { "name": "ğŸ‘¤ æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼", "value": "'"${SENDER}"'", "inline": true },
                     { "name": ":deciduous_tree: ãƒ–ãƒ©ãƒ³ãƒ", "value": "'"${BRANCH}"'", "inline": true }
                   ]
                 }],
                 "components": [
                   {
                     "type": 1,
                     "components": [
                       {
                         "type": 2,
                         "style": 5,
                         "label": "GitHubã§ç¢ºèªã™ã‚‹",
                         "url": "'"${URL}"'"
                       }
                     ]
                   }
                 ]
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}
