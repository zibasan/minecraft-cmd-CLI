name: Discord Component Notification

permissions:
  contents: read

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]
    types: [opened, closed, synchronize]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  create: # Branch or tag creation
  discussion_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request || github.event_name != 'issue_comment'
    steps:
      - name: Prepare Notification Details
        id: info
        run: |
          # --- IDãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•° ---
          # é€šå¸¸æ™‚ç”¨ï¼ˆé€†è»¢ãƒ­ã‚¸ãƒƒã‚¯ï¼šactorè‡ªèº«ã§ã¯ãªãç›¸æ‰‹ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼‰
          get_mention_reverse() {
            case "$1" in
              "tukuyomil032") echo "<@745902312345567252>" ;;
              "zibasan")      echo "<@1100794879019323393>" ;;
              *)              echo "@here" ;;
            esac
          }

          # --- ã‚³ãƒŸãƒƒãƒˆæ•´å½¢é–¢æ•° ---
            format_commits() {
              local json="$1"
              local target_url="$2"
              local count=$(echo "$json" | jq '. | length')
              # æœ€æ–°4ä»¶ã‚’å–å¾—ã—ã¦æ•´å½¢ (7æ¡SHA ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸1è¡Œç›®)
              local list=$(echo "$json" | jq -r 'reverse | .[:4] | .[] | "\(.sha[0:7]) \(.message | split("\n")[0])"' | sed 's/^/`/; s/$/`/')

              echo "$list"
              if [ "$count" -gt 4 ]; then
                echo "ä»– [$((count - 4)) ä»¶ã®ã‚³ãƒŸãƒƒãƒˆ]($target_url)..."
              fi
            }

          # åŸºæœ¬ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆæ“ä½œã—ãŸäººãƒ»é€šå¸¸æ™‚ã¯é€†è»¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
          MENTION=$(get_mention_reverse "${{ github.actor }}")

          case "${{ github.event_name }}" in
            "push")
              TITLE="ğŸ“¦ ãƒ–ãƒ©ãƒ³ãƒ${{ github.ref_name }}ã«pushã•ã‚Œã¾ã—ãŸ: ${{ github.event.head_commit.message }}"
              COMMITS_JSON='${{ toJson(github.event.commits) }}'
              DESC="**ã‚³ãƒŸãƒƒãƒˆå†…å®¹**\n$(format_commits "$COMMITS_JSON")"
              URL="${{ github.event.compare }}"
              MENTION="@here"
              COLOR=3066993
              BRANCH="${{ github.ref_name }}"
              ;;
            "pull_request")
              if [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE=":white_check_mark: PRãŒMergeã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=6570404
                # ãƒãƒ¼ã‚¸æ™‚ã¯ã€Œãƒãƒ¼ã‚¸ã—ãŸäººã€ã¨ã€ŒPRä½œæˆè€…ã€ã®ä¸¡æ–¹ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
                AUTHOR_MENTION="@here"
                MENTION="$AUTHOR_MENTION"
              elif [ "${{ github.event.action }}" = "closed" ]; then
                TITLE=":x: PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=15158332
              else
                TITLE=":new: PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=3066993
              fi
              COMMITS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" ${{ github.event.pull_request.commits_url }})
              COMMIT_LIST=$(format_commits "$COMMITS_JSON" "$COMMITS_PAGE_URL")
              DESC="ğŸ¯ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆ**\n$COMMIT_LIST"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"

              PR_URL="${{ github.event.pull_request.html_url }}"
              URL="$PR_URL"
              # PRã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆã‚¿ãƒ–ã®URLã‚’ç”Ÿæˆ
              COMMITS_PAGE_URL="${PR_URL}/commits"
              ;;
            "pull_request_review")
              TITLE="ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ github.event.review.state }}"
              DESC="Pull Request: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.review.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570
              ;;
            "issue_comment")
              TITLE="ğŸ’¬ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="Pull Request #${{ github.event.issue.number }}"
              COLOR=12370112
              ;;
            "create")
              TITLE="ğŸŒ¿ ${{ github.event.ref_type }}ã®ä½œæˆ: ${{ github.event.ref }}"
              DESC="ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
              URL="https://github.com/${{ github.repository }}/tree/${{ github.event.ref }}"
              BRANCH="${{ github.event.ref }}"
              COLOR=3066993
              ;;
            "discussion_comment")
              TITLE="ğŸ’¬ Discussionã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="Discussions"
              COLOR=12370112
              ;;
            "pull_request_review_comment")
              TITLE="ğŸ“ PRã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="${{ github.event.pull_request.base.ref }} <-- ${{ github.event.pull_request.head.ref }}"
              COLOR=15105570
              ;;
          esac

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "mention=$MENTION" >> $GITHUB_OUTPUT

      - name: Send Discord Webhook Embed
        shell: bash
        env:
          TITLE: ${{ steps.info.outputs.title }}
          DESC: ${{ steps.info.outputs.desc }}
          URL: ${{ steps.info.outputs.url }}
          COLOR: ${{ steps.info.outputs.color }}
          BRANCH: ${{ steps.info.outputs.branch }}
          MENTION: ${{ steps.info.outputs.mention }}
          SENDER: ${{ github.actor }}
        run: |
            SAFE_DESC=$(printf '%s' "$DESC" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

            # 1. å¤‰æ•°ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
            TITLE_VAL="${TITLE:-No Title}"
            DESC_VAL="${DESC:-No Description}"
            COLOR_VAL="${COLOR:-3066993}"

            # 2. curlã§JSONã‚’é€ä¿¡ (componentsãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤)
            curl -H "Content-Type: application/json" \
                  -X POST \
                  -d '{
                    "content": "'"${MENTION}"'",
                    "embeds": [{
                      "title": "'"${TITLE_VAL//\"/\\\"}"'",
                      "description": "'"${DESC_VAL//\"/\\\"}"'",
                      "color": '"${COLOR_VAL}"',
                      "url": "'"${URL}"'",
                      "author": {
                        "name": "'"${SENDER}"'",
                        "icon_url": "https://github.com/'"${SENDER}"'.png",
                        "url": "https://github.com/'"${SENDER}"'"
                      },
                      "fields": [
                        { "name": "ğŸ‘¤ æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼", "value": "'"${SENDER}"'", "inline": true },
                        { "name": ":herb: ãƒ–ãƒ©ãƒ³ãƒ", "value": "'"${BRANCH}"'", "inline": true }
                      ]
                    }]
                  }' \
                  ${{ secrets.DISCORD_WEBHOOK }}
