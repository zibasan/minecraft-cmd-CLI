name: Discord Component Notification

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]
    types: [opened, closed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request || github.event_name != 'issue_comment' # PRã«é–¢é€£ã—ãªã„Issueã‚³ãƒ¡ãƒ³ãƒˆã¯é™¤å¤–
    steps:
      - name: Prepare Notification Details
        id: info
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆåã«ã‚ˆã£ã¦å¤‰æ•°ã®ä¸­èº«ã‚’ã‚¹ã‚¤ãƒƒãƒ
          case "${{ github.event_name }}" in
            "push")
              TITLE="ğŸ“¦ ãƒ–ãƒ©ãƒ³ãƒ${{ github.ref_name }}ã«pushã•ã‚Œã¾ã—ãŸ"
              DESC="ã‚³ãƒŸãƒƒãƒˆå†…å®¹: ${{ github.event.head_commit.message }}"
              URL="${{ github.event.compare }}"
              COLOR=3066993 # Blue
              ;;
            "pull_request")
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE=":white_check_mark: PRãŒMergeã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=6570404 # Purple
              elif [ "${{ github.event.action }}" = "closed" ]; then
                TITLE=":x: PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=15158332 # Red
              else
                TITLE=":new: PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ: #${{ github.event.pull_request.number }}"
                COLOR=3066993 # Blue
              fi
              DESC="${{ github.event.pull_request.title }}"
              BRANCH="${{ github.base_ref }} --> ${{ github.head_ref }}"
              URL="${{ github.event.pull_request.html_url }}"
              ;;
            "pull_request_review")
              TITLE="ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${{ github.event.review.state }}"
              DESC="Pull Request: ${{ github.event.pull_request.title }}"
              URL="${{ github.event.review.html_url }}"
              BRANCH="${{ github.base_ref }} --> ${{ github.head_ref }}"
              COLOR=15105570 # Orange
              ;;
            "issue_comment")
              TITLE="ğŸ’¬ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
              DESC="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              BRANCH="${{ github.ref_name }}"
              COLOR=12370112 # Grey
              ;;
          esac

          # å‡ºåŠ›å¤‰æ•°ã¨ã—ã¦ä¿å­˜
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Send Discord Webhook Embed
        shell: bash
        env:
            # ã™ã¹ã¦ã®å‡ºåŠ›ã‚’ã“ã“ã§ç’°å¢ƒå¤‰æ•°ã«ãƒãƒƒãƒ”ãƒ³ã‚°
            # ã“ã‚Œã«ã‚ˆã‚Šã€Œinfoã‚¹ãƒ†ãƒƒãƒ—ãŒå­˜åœ¨ã™ã‚‹ã‹ã€ã®ãƒã‚§ãƒƒã‚¯ãŒã“ã“ä¸€ç‚¹ã«é›†ç´„ã•ã‚Œã¾ã™
            TITLE: ${{ steps.info.outputs.title }}
            DESC: ${{ steps.info.outputs.desc }}
            URL: ${{ steps.info.outputs.url }}
            COLOR: ${{ steps.info.outputs.color }}
            BRANCH: ${{ steps.info.outputs.branch }}
            SENDER: ${{ github.actor }}
        run: |
          # 1. å¿µã®ãŸã‚ã€å¤‰æ•°ãŒç©ºã ã£ãŸå ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
          TITLE_VAL="${TITLE:-No Title}"
          DESC_VAL="${DESC:-No Description}"
          COLOR_VAL="${COLOR:-3066993}" # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Blue

          # 2. JSONã‚’çµ„ã¿ç«‹ã¦ã¦é€ä¿¡
          # ç‰¹æ®Šæ–‡å­—ã«ã‚ˆã‚‹JSONå´©ã‚Œã‚’é˜²ããŸã‚ã€å¤‰æ•°å±•é–‹æ™‚ã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®ç½®æ›ã‚’æŒŸã‚“ã§ã„ã¾ã™
          curl -H "Content-Type: application/json" \
                -X POST \
                -d '{
                  "embeds": [{
                    "title": "'"${TITLE_VAL//\"/\\\"}"'",
                    "description": "'"${DESC_VAL//\"/\\\"}"'",
                    "color": '"${COLOR_VAL}"',
                    "url": "'"${URL}"'",
                    "author": {
                      "name": "'"${SENDER}"'",
                      "icon_url": "https://github.com/'"${SENDER}"'.png",
                      "url": "https://github.com/'"${SENDER}"'"
                    },
                    "fields": [
                      { "name": "ğŸ‘¤ æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼", "value": "'"${SENDER}"'", "inline": true },
                      { "name": ":deciduous_tree: ãƒ–ãƒ©ãƒ³ãƒ", "value": "'"${BRANCH}"'", "inline": true }
                    ]
                  }],
                  "components": [
                    {
                      "type": 1,
                      "components": [
                        {
                          "type": 2,
                          "style": 5,
                          "label": "GitHubã§ç¢ºèªã™ã‚‹",
                          "url": "'"${URL}"'"
                        }
                      ]
                    }
                  ]
                }' \
                ${{ secrets.DISCORD_WEBHOOK }}
